[build]
  command = "cd packages/backend && npx convex deploy --cmd 'cd ../../apps/web && turbo run build' --cmd-url-env-var-name VITE_CONVEX_URL"
  publish = "apps/web/dist/client"

# Function configuration
[functions]
  node_bundler = "esbuild"
  included_files = ["apps/web/dist/**"]

# Edge Functions for low-latency operations
[[edge_functions]]
  path = "/api/auth/*"
  function = "auth-middleware"

# Deploy contexts for environment-specific configurations
[context.production]
  command = "cd packages/backend && npx convex deploy --prod --cmd 'cd ../../apps/web && turbo run build' --cmd-url-env-var-name VITE_CONVEX_URL"
  [context.production.environment]
    NODE_ENV = "production"
    VITE_ENV = "production"

[context.branch-deploy]
  command = "cd packages/backend && npx convex deploy --cmd 'cd ../../apps/web && turbo run build' --cmd-url-env-var-name VITE_CONVEX_URL"
  [context.branch-deploy.environment]
    NODE_ENV = "development"
    VITE_ENV = "staging"

[context.deploy-preview]
  command = "cd packages/backend && npx convex deploy --cmd 'cd ../../apps/web && turbo run build' --cmd-url-env-var-name VITE_CONVEX_URL"
  [context.deploy-preview.environment]
    NODE_ENV = "development"
    VITE_ENV = "preview"

# Environment variables (declare here for documentation)
# Actual values should be set in Netlify UI or via CLI
[build.environment]
  NODE_VERSION = "20"
  # Convex
  VITE_CONVEX_URL = "$VITE_CONVEX_URL"
  EXPO_PUBLIC_CONVEX_URL = "$EXPO_PUBLIC_CONVEX_URL"
  EXPO_PUBLIC_CONVEX_SITE_URL = "$EXPO_PUBLIC_CONVEX_SITE_URL"
  CONVEX_DEPLOY_KEY = "$CONVEX_DEPLOY_KEY"
  
  # Firecrawl
  FIRECRAWL_API_KEY = "$FIRECRAWL_API_KEY"
  
  # Cloudflare
  VITE_CLOUDFLARE_TURNSTILE_SITE_KEY = "$VITE_CLOUDFLARE_TURNSTILE_SITE_KEY"
  CLOUDFLARE_TURNSTILE_SECRET_KEY = "$CLOUDFLARE_TURNSTILE_SECRET_KEY"
  
  # Sentry
  VITE_SENTRY_DSN = "$VITE_SENTRY_DSN"
  VITE_SENTRY_RELEASE = "$VITE_SENTRY_RELEASE"

# Asset optimization
[[plugins]]
  package = "@netlify/plugin-lighthouse"

# Redirects and rewrites are handled via _redirects file in public/

